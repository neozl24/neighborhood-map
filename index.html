<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>武汉地图</title>
  <style>
  html,
  body {
    font-family: Arial, sans-serif;
    height: 100%;
    margin: 0;
    padding: 0;
  }
  .options-container {
    position: relative;
    padding: 30px 20px;
    height: 100%;
    width: 360px;
    box-sizing: border-box;
    line-height: 30px;
    text-align: left;
    background: #30404f;
    color: #fff;
    font-size: 0;
  }
  .filter-input {
    width: 260px;
    height: 30px;
    padding: 0 10px;
    box-sizing: border-box;
    border: none;
    outline: none;
    font-size: 14px;
  }
  .filter-button {
    width: 60px;
    height: 30px;
    vertical-align: top;
    background-color: #0087fa;
    color: #fff;
    border: none;
    outline: none;
    font-size: 14px;
    cursor: pointer;
  }
  .filter-button:hover {
    opacity: 0.8;
  }
  .filter-button:active {
    opacity: 0.9;
  }
  .map-container {
    position: absolute;
    top: 0;
    left: 360px;
    right: 0;
    height: 100%;
  }
  .map-topbar {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    background-color: #1c272f;
    color: #fff;
    z-index: 100;
  }
  .map-title {
    text-align: center;
    margin: 0;
    line-height: 40px;
  }
  .location-list {
    margin: 0;
    padding: 0;
    list-style: none;
    color: #fff;
    font-size: 14px;
    transform: translateY(-6px);
  }
  .location-item {
    padding-left: 20px;
    height: 40px;
    line-height: 40px;
    background-color: rgba(20, 30, 50, 0.5);
    user-select: none;
    cursor: pointer;
  }
  .location-item:hover {
    background-color: rgba(20, 30, 50, 0.7);
  }
  .location-item:active {
    background-color: rgba(20, 30, 50, 0.8);
  }
  .location-item-selected {
    background-color: rgba(55, 65, 120, 0.8) !important;
  }
  .map {
    position: absolute;
    top: 40px;
    bottom: 0;
    left: 0;
    right: 0;
  }
  </style>
</head>

<body>
  <div class="options-container">
    <input type="text" id="place-text" data-bind="value: inputText" class="filter-input" placeholder="请输入地址名或关键字">
    <input type="button" id="filter-button" data-bind="click: filterLocations" class="filter-button" value="筛 选">
    <ul data-bind="foreach: locationList" class="location-list">
      <li data-bind="text: name, visible: display(), click: $root.selectItem,
        css: {'location-item-selected': highlight()}" class="location-item"></li>
    </ul>
  </div>
  <div class="map-container">
    <div class="map-topbar">
      <h3 class="map-title">Wuhan Location</h3>
    </div>
    <div class="map" id="map"></div>
  </div>

  <script type="text/javascript" src="https://cdn.bootcss.com/knockout/3.4.2/knockout-min.js"></script>
  <script type="text/javascript">

  var map;

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: {
        lat: 30.587,
        lng: 114.292
      },
      zoom: 13
    });

    var placeText = document.getElementById('place-text');
    var filterButton = document.getElementById('filter-button');

    // 当用户点击某一个 marker 的时候，会读取详细信息
    function getPlacesDetails(marker, infowindow) {
      var service = new google.maps.places.PlacesService(map);
      service.getDetails({
        placeId: marker.id
      }, function(place, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          // Set the marker property on this infowindow so it isn't created again.
          infowindow.marker = marker;
          var innerHTML = '<div>';
          if (place.name) {
            innerHTML += '<strong>' + place.name + '</strong>';
          }
          if (place.formatted_address) {
            innerHTML += '<br>' + place.formatted_address;
          }
          if (place.formatted_phone_number) {
            innerHTML += '<br>' + place.formatted_phone_number;
          }
          if (place.opening_hours) {
            innerHTML += '<br><br><strong>Hours:</strong><br>' +
              place.opening_hours.weekday_text[0] + '<br>' +
              place.opening_hours.weekday_text[1] + '<br>' +
              place.opening_hours.weekday_text[2] + '<br>' +
              place.opening_hours.weekday_text[3] + '<br>' +
              place.opening_hours.weekday_text[4] + '<br>' +
              place.opening_hours.weekday_text[5] + '<br>' +
              place.opening_hours.weekday_text[6];
          }
          if (place.photos) {
            innerHTML += '<br><br><img src="' +
              place.photos[0].getUrl({maxHeight: 100, maxWidth: 200}) + '">';
          }
          innerHTML += '</div>';
          infowindow.setContent(innerHTML);
          infowindow.open(map, marker);
          // Make sure the marker property is cleared if the infowindow is closed.
          infowindow.addListener('closeclick', function() {
            infowindow.marker = null;
          });
        }
      });
    }

    // var bounds = new google.maps.LatLngBounds();

    var defaultIcon = makeMarkerIcon('0091ff');
    var highlightedIcon = makeMarkerIcon('ffff24');


    // 以颜色为参数，返回一个特定大小的 MarkerImage
    function makeMarkerIcon(markerColor) {
      var markerImage = new google.maps.MarkerImage(
        'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+ markerColor +
        '|40|_|%E2%80%A2',
        new google.maps.Size(21, 34),
        new google.maps.Point(0, 0),
        new google.maps.Point(10, 34),
        new google.maps.Size(21,34));
      return markerImage;
    }

    function populateInfoWindow(marker, infoWindow) {
      if (infoWindow.marker !== marker) {
        infoWindow.marker = marker;
        infoWindow.setContent('<div>' + marker.title + '</div>');
        infoWindow.open(map, marker);
        infoWindow.addListener('closeclick', function() {
          infoWindow.marker = null;
        });
      }
    }

    // 用来表示列表项的类
    function Location(name) {
      var self = this;
      self.name = name;
      // 新建这个列表项时，默认是不处于高亮状态的，但这个状态会在之后的点击时被触发
      self.highlight = ko.observable(false);
      // 默认状态下，该列表项处于显示状态，但是改变筛选条件后，可能会隐藏掉
      self.display = ko.observable(true);
    }

    function MapViewModel() {
      var self = this;

      self.inputText = '';

      // 本来不准备把 markers 放在 ViewModel 里面的，但是它的点击事件涉及到 locationList 的状态变化，
      // 也就是说 markers 的状态和 ViewModel 产生了关联，因此将 markers 声明为了 ViewModel 内部的数组，
      // 方便接下来要写的 marker 点击事件回调函数
      self.markers = [];

      self.locationList = [];

      var locations = [
        {title: '中山公园', location: {lat: 30.582100, lng: 114.272900}},
        {title: '解放公园', location: {lat: 30.606346, lng: 114.295498}},
        {title: '民生银行大厦', location: {lat: 30.5943940, lng: 114.272755}},
        {title: '新佳丽时尚广场', location: {lat: 30.5788516, lng: 114.2911021}},
        {title: '武汉国际广场', location: {lat: 30.5810010, lng: 114.2706120}},
        {title: '楚河汉街', location: {lat: 30.5538480, lng: 114.3414150}},
        {title: '武汉图书馆', location: {lat: 30.6031300, lng: 114.281808}},
        {title: '武汉二中', location: {lat: 30.6071929, lng: 114.3110464}},
        {title: '明珠豪生大酒店', location: {lat: 30.5908888, lng: 114.3039332}},
        {title: '汉口火车站', location: {lat: 30.6154870, lng: 114.2549610}},
        {title: '琴台大剧院', location: {lat: 30.5610320, lng: 114.2594810}}
      ];

      // 遍历 locations 数组，创建对应的列表条目和地图标记，并给标记绑定点击事件
      for (var index = 0; index < locations.length; index++) {
        var position = locations[index].location;
        var title = locations[index].title;

        self.locationList.push(new Location(title));

        var marker = new google.maps.Marker({
          position: position,
          title: title,
          animation: google.maps.Animation.DROP,
          icon: defaultIcon,
          id: index
        });

        self.markers.push(marker);
        marker.setMap(map);

        var infoWindow = new google.maps.InfoWindow({
          content: ''
        });

        // 用立即执行的办法绑定标记所对应的索引值，从而改变对应列表项的高亮状态
        (function(i) {
          marker.addListener('click', function() {
            self.clearSelection();
            this.setIcon(highlightedIcon);
            populateInfoWindow(this, infoWindow);
            self.locationList[i].highlight(true);
          });
        })(index);
      }

      // 筛选地点函数，点击筛选按钮触发
      self.filterLocations = function() {
        for (var i = 0; i < self.locationList.length; i++) {
          // 过滤掉输入内容里的空格
          var keyword = self.inputText.replace(/[ ]/g, '');
          var display = self.locationList[i].name.indexOf(keyword) >= 0;
          self.locationList[i].display(display);
          // 同时更新地图内的图标显示
          self.markers[i].setMap(display ? map : null);
        }
      };

      // 清除已选中的条目，并将所有标记恢复至默认状态
      self.clearSelection = function() {
        for (var i = 0; i < self.locationList.length; i++) {
          self.locationList[i].highlight(false);
          self.markers[i].setIcon(defaultIcon);
        }
      };

      // 点击列表项，会让该条目变为高亮状态，对应的地图图标也会随之变化
      self.selectItem = function(location) {
        self.clearSelection();
        location.highlight(true);

        // 找到对应的标记，并打开详情窗口
        for (var i = 0; i < self.locationList.length; i++) {
          if (self.locationList[i].name === location.name) {
            self.markers[i].setIcon(highlightedIcon);
            populateInfoWindow(self.markers[i], infoWindow);
          }
        }
      };
    }

    ko.applyBindings(new MapViewModel());
  }
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyAbrsJBAgSnyTQOpOT-WSpOfSnRx99HIrE&v=3&callback=initMap">
  </script>
</body>

</html>
